\section{\texorpdfstring{Просто типизированное $\lambda$-исчисление}{Simply typed lambda calculus}}

\begin{definition}[тип]
    $T = \{\alpha, \beta, \gamma, \ldots\}$ "--- множество типов.
    $\sigma$, $\tau$ "--- метапеременные для типов.
    Если $\tau$, $\sigma$ "--- типы, то $\sigma \rightarrow \tau$ "--- тип.
    \begin{bnf}
    \[
        \Pi ::= T | \Pi \rightarrow \Pi | (\Pi)
    \]
    \end{bnf}
    $\left(\rightarrow\right)$ правоассоциативна.
\end{definition}

\begin{definition}[контекст] Контекст "--- $\Gamma$.
\begin{gather*}
    \Gamma = \{ \Lambda_{1} : \sigma_{1};\ \Lambda_{2} : \sigma_{2}\ \ldots\ \Lambda_{n} : \sigma_{n} \} \\
    \abs{\Gamma} = \{ \sigma_{1},\ \sigma_{2}\ \ldots\ \sigma_{n} \} \\
    \dom \Gamma = \{ \Lambda_{1},\ \Lambda_{2}\ \ldots\ \Lambda_{n} \}
\end{gather*}
\end{definition}

\subsection{\texorpdfstring{Исчисление по Карри}{Curry-style}}

\begin{definition}[типизируемость по Карри]
    Рассмотрим исчисление со следующими правилами:
    \begin{enumerate}
        \item $\infer[(x \notin \dom(\Gamma))]
            {\Gamma, x:\sigma \vdash x:\sigma}
            {}$
        \item $\infer[]
            {\Gamma \vdash M N : \tau}
            {\Gamma \vdash M:\sigma \rightarrow \tau && \Gamma \vdash N:\sigma}$
        \item $\infer[(x \notin \dom(\Gamma))]
            {\Gamma \vdash \lambda x . M : \sigma \rightarrow \tau}
            {\Gamma, x : \sigma \vdash M : \tau}$
    \end{enumerate}
    Если $\lambda$-выражение типизируется этими трёмя правилами, то говорят, что оно типизируется по Карри.
\end{definition}

\begin{lemma}[subject reduction]
    Если $\Gamma \vdash M : \sigma$ и $M \rightarrow_{\beta}N$, то $\Gamma \vdash N : \sigma$.
\end{lemma}

\begin{corollary}
    Если $\Gamma \vdash M : \sigma$ и $M \twoheadrightarrow_{\beta}N$, то $\Gamma \vdash N : \sigma$.
\end{corollary}

\begin{theorem}[Чёрча-Россера]
    Если $\Gamma \vdash M : \sigma$, $M \twoheadrightarrow_{\beta} N$ и $M \twoheadrightarrow_{\beta} P$, тогда найдётся $Q$, что
    $N \twoheadrightarrow_{\beta} Q$, $P \twoheadrightarrow_{\beta} Q$ и $\Gamma \vdash Q : \sigma$.
\end{theorem}

\begin{example} Несколько доказательств:
    \begin{enumerate}
        \item Докажем $\lambda x . x : \alpha \rightarrow \alpha$:
        \[
            \infer[(3)]
                {\vdash \lambda x . x : \alpha \rightarrow \alpha}
                { \infer[(1)]
                    {x : \alpha \vdash x : \alpha}
                    {}
                }
        \]

        \item Докажем $\lambda f . \lambda x . f x : (\alpha \rightarrow \beta) \rightarrow \alpha \rightarrow \beta$:
        \[
            \infer[(3)]
                { \vdash \lambda f . \lambda x . f x : (\alpha \rightarrow \beta) \rightarrow (\alpha \rightarrow \beta) }
                { \infer[(3)]
                    { f : \alpha \rightarrow \beta \vdash \lambda x . f x : \alpha \rightarrow \beta }
                    { \infer[(2)]
                        {f : \alpha \rightarrow \beta; x : \alpha \vdash f x : \beta}
                        {
                            \infer[(1)]{ \Gamma \vdash f : \alpha \rightarrow \beta }{} &&
                            \infer[(1)]{ \Gamma \vdash x : \alpha }{}
                        }
                    }
                }
        \]

        \item $\combl \Omega и \comb Y$ не типизируемы. Допустим обратное.
        Тогда в выводе должен будет присутствовать вывод подвыражения $xx$:
        \[
            \infer{\Gamma, x : \sigma \rightarrow \tau, x : \sigma \vdash x x : \tau}
            {  \infer{\Gamma, x : \sigma \rightarrow \tau, x : \sigma \vdash x : \sigma \rightarrow \tau}{}
            && \infer{\Gamma, x : \sigma \rightarrow \tau, x : \sigma \vdash x : \sigma}{}
            }
        \]
        Однако первое правило вывода запрещает повторение переменных в контексте. Значит, такой вывод не может быть корректным.

    \end{enumerate}
\end{example}

\begin{lemma}[отсутствие subject expansion]
    Неверно, что если $M \rightarrow_{\beta} N$, $\Gamma \vdash N : \sigma$, то $\Gamma \vdash M : \sigma$.
\end{lemma}
Например, для $\comb K a \combl\Omega$.

В общем случае тип не уникален, бывает, что одновременно $\vdash \lambda x . x : \alpha \rightarrow \alpha$ и $\vdash \lambda x . x : (\beta \rightarrow \beta) \rightarrow (\beta \rightarrow \beta)$.

\begin{definition}[сильная нормализация] \label{strong-normalization}
    Назовём исчисление сильно-нормализуемым, если любая последовательность $\beta$-редукций неизбежно приводит к нормальной форме.
\end{definition}
Или, иными словами, если не существует бесконечной последовательности $\beta$-редукций.

\begin{definition}[слабая нормализация]
    Назовём исчисление слабо-нормализуемым, если для любого терма существует последовательность $\beta$-редукций, приводящая его к нормальной форме.
\end{definition}

\begin{theorem}[о сильной нормализации]
    Просто типизируемое $\lambda$-исчисление сильно нормализуемо.
    Любое просто типизируемое $\lambda$-выражение сильно нормализуемо.
\end{theorem}

\subsection{\texorpdfstring{Исчисление по Чёрчу}{Church-style}}

\begin{definition}[Типизация по Чёрчу]
    \begin{bnf}
    \[
        \Lambda_{\xx} ::= x | \lambda x^{\sigma}.\Lambda_{\xx} | (\Lambda_{\xx}) | \Lambda_{\xx} \Lambda_{\xx}
    \]
    \end{bnf}
    Правила:
    \begin{enumerate}
        \item $\infer[(x \notin \dom(\Gamma))]
            {\Gamma, x:\sigma \vdash_{\xx} x:\sigma}
            {}$
        \item $\infer[]
            {\Gamma \vdash_{\xx} M N : \tau}
            {\Gamma \vdash_{\xx} M:\sigma \rightarrow \tau && \Gamma \vdash_{\xx} N:\sigma}$
        \item $\infer[(x \notin \dom(\Gamma))]
            {\Gamma \vdash_{\xx} \lambda x^{\sigma} . M : \sigma \rightarrow \tau}
            {\Gamma, x : \sigma \vdash_{\xx} M : \tau}$
    \end{enumerate}

\end{definition}

\begin{definition}
\[
    \abs{\Lambda_{\xx}} =
    \begin{cases}
        x                                   & \Lambda_{\xx} \equiv x \\
        \abs{\Lambda_{1}} \abs{\Lambda_{2}} & \Lambda_{\xx} \equiv \Lambda_{1} \Lambda_{2} \\
        \lambda x . \abs{\Lambda}           & \Lambda_{\xx} \equiv \lambda x^{\sigma} . \Lambda
    \end{cases}
\]
\end{definition}

\begin{lemma}[subject reduction по Чёрчу]
    Пусть $\Gamma \vdash_{\xx} M : \sigma$ и $\abs{M} \rightarrow_{\beta} N$. \\
    Тогда найдётся такое $H$, что $\abs{H} = N$, $\Gamma \vdash_{\xx} H:\sigma$.
\end{lemma}

\begin{theorem}[Чёрча-Россера]
    Пусть $\Gamma \vdash_{\xx} M : \sigma$, $\abs{M} \twoheadrightarrow_{\beta} N$, $\abs{M} \twoheadrightarrow_{\beta} T$. \\
    Тогда найдётся такое $P$, что $\Gamma \vdash_{\xx} P : \sigma$,
            $N \twoheadrightarrow_{\beta} \abs{P}$ и $T \twoheadrightarrow_{\beta} \abs{P}$.
\end{theorem}

\begin{lemma}[Уникальность типов] \label{uniqueness}
    Если $\Gamma \vdash_\xx M : \gamma$ и $\Gamma \vdash_\xx M : \tau$, то $\sigma = \tau$.
\end{lemma}

Лемма \ref{uniqueness} показывает, чем исчисление по Чёрчу отличается исчислением по Карри.

\begin{theorem}[о стирании] \ 
    \begin{enumerate}
        \item Если $M \rightarrow_{\beta} N$ и $\Gamma \vdash_{\xx} M : \sigma$, то $\abs{M} \rightarrow_{\beta} \abs{N}$.
        \item Если $\Gamma \vdash_{\xx} M : \sigma$, то $\Gamma \vdash_{к} \abs{M} : \sigma$.
    \end{enumerate}
\end{theorem}

\begin{theorem}[о поднятии]
    Пусть $P \in \Lambda_{\xx}$, $M, N \in \Lambda_{\rr}$.
    \begin{enumerate}
        \item Если $M \rightarrow_{\beta} N$, $\abs{P} = M$, то найдётся такое $Q$, что $\abs{Q} = N$, $P \rightarrow_{\beta} Q$.
        \item Если $\Gamma \vdash_{\rr} M : \sigma$, то найдётся такое $P \in \Lambda_{\xx}$, что
                $\Gamma \vdash_{\xx} P : \sigma$, $\abs{P} = M$.
    \end{enumerate}
\end{theorem}

\subsection{\texorpdfstring{Изоморфизм Карри-Ховарда}{Curry-Howard correspondence}}

Давайте введём два новых типа данных.
Первый "--- тип "<пары">. Если $A : \sigma$ и $B : \tau$, то $\pair{A}{B} : \sigma \with \tau$. Пара нам уже знакома.
Введём также функции доступа к элементам пары: $\pi_1 : \sigma\with\tau\rightarrow\sigma$ и $\pi_2 : \sigma\with\tau\rightarrow\tau$
"--- левая и правая проекции.
Например, $\pi_2 \pair{\overline 7}{\overline 5} =_\beta \overline 5$.

Второй "--- алгебраический тип данных. Если $A : \sigma$ и $B : \tau$, то $\inj_1 A : \sigma \vee \tau$ и $\inj_2 : \sigma \vee \tau$.
$\inj_1$ и $\inj_2$ это левая и правая инъекции.
Тип $\sigma \vee \tau$ означает, что это либо $\sigma$, либо $\tau$.
Его можно понимать как \mintinline{C++}{union}, который дополнительно хранит в себе информацию о типе, который в нём записан.

Для доступа к содержимому экземпляра алгебраического типа введём конструкцию case.
\[
T : \sigma \vee \tau \qquad A : \sigma \rightarrow \pi \qquad B : \tau \rightarrow \pi \qquad \case{T}{A}{B} : \pi
\]
Рассмотрим такой код на Haskell: \mintinline{Haskell}{data Fruit = Orange Int | Banana Int}.
В нём \mintinline{Haskell}{Orange :: Int -> Fruit} это левая инъекция, \mintinline{Haskell}{Banana :: Int -> Fruit} "--- правая.
На нашем языке можно сказать, что $\mathinner\mathtt{Fruit} = \mathinner{\mathtt{Int}} \vee \mathinner{\mathtt{Int}}$.
Тогда если $T \mathinner{:} \mathtt{Fruit}$, то $\case{T}{(+1)}{(-1)} \mathinner{:} \mathrel{\mathtt{Int}}$ это число,
хранящееся в фрукте, увеличенное на единицу, если это апельсин, и уменьшенное на единицу, если это банан.

Можно отчётливо проследить связь между аксиомами типизированного $\lambda$-исчисления и аксиомами ИИВ
(таблицы \ref{correspondence-table}, \ref{correspondence-terms-table}).

\begin{table}
\centering
\begin{tabular}{Sc@{\hspace{1.5cm}} Sc} \toprule
    ИИВ & Типизированное $\lambda$-исчисление \\ \midrule

    $\infer{\Gamma \vdash \psi}{\Gamma \vdash \varphi \rightarrow \psi && \Gamma \vdash \varphi}$ &
    $\infer{\Gamma \vdash AB : \psi}{\Gamma \vdash A : \varphi \rightarrow \psi && \Gamma \vdash B : \varphi}$ \\ \addlinespace

    $\infer{\Gamma \vdash \varphi \rightarrow \psi}{\Gamma, \varphi \vdash \psi}$ &
    $\infer{\Gamma \vdash \lambda x^\varphi . A : \varphi \rightarrow \psi}{\Gamma, x : \varphi \vdash A : \psi}$ \\ \midrule

    $\infer{\Gamma \vdash \varphi \with \psi}{\Gamma \vdash \varphi && \Gamma \vdash \psi}$ &
    $\infer{\Gamma \vdash \left<A,B\right> : \varphi \with \psi}{\Gamma \vdash A : \varphi && \Gamma \vdash B : \psi}$ \\ \addlinespace

    $\infer{\Gamma \vdash \varphi}{\Gamma \vdash \varphi \with \psi}$ &
    $\infer{\Gamma \vdash \pi_1 R : \varphi}{\Gamma \vdash R : \varphi \with \psi}$ \\ \addlinespace

    $\infer{\Gamma \vdash \psi}{\Gamma \vdash \varphi \with \psi}$ &
    $\infer{\Gamma \vdash \pi_2 R : \psi}{\Gamma \vdash R : \varphi \with \psi}$ \\ \midrule

    $\infer{\Gamma \vdash \varphi \vee \psi}{\Gamma \vdash \varphi}$ &
    $\infer{\Gamma \vdash \inj_1 A : \varphi \vee \psi}{\Gamma \vdash A : \varphi}$ \\ \addlinespace

    $\infer{\Gamma \vdash \varphi \vee \psi}{\Gamma \vdash \psi}$ &
    $\infer{\Gamma \vdash \inj_2 A : \varphi \vee \psi}{\Gamma \vdash A : \psi}$ \\ \addlinespace

    $\infer{\Gamma \vdash \varphi \vee \psi \rightarrow \pi}
        {\Gamma \vdash \varphi \rightarrow \pi && \Gamma \vdash \psi \rightarrow \pi}$ &
    $\infer{\Gamma \vdash \case{T}{A}{B} : \pi}{\Gamma \vdash T : \varphi \vee \psi &&
        \Gamma \vdash A : \varphi \rightarrow \pi && \Gamma \vdash B : \psi \rightarrow \pi}$ \\ \bottomrule
\end{tabular}
%\captionsetup{labelformat=empty}
\caption{Соответствие правил вывода}
\label{correspondence-table}
\end{table}

\begin{table}
\centering
\begin{tabular}{Sl Sl} \toprule
    Интуиционистская логика & $\lambda$-исчисление \\ \midrule
    выражение & тип \\
    доказательство & терм (программа) \\
    предположение & свободная переменная \\
    импликация & абстракция (функция) \\ \bottomrule
\end{tabular}
%\captionsetup{labelformat=empty}
\caption{Соответствие сущностей}
\label{correspondence-terms-table}
\end{table}

\begin{theorem}[об изоморфизме Карри-Ховарда] \ 
    \begin{enumerate}
        \item Пусть $\Gamma \vdash \sigma$ в и.ф.и.и.в., тогда найдётся такой терм M,
            что $\Delta \vdash_{\xx} M : \sigma$, где $\Delta=\left\{ \left(x^\varphi : \varphi \right) \mid \varphi \in \Gamma \right\}$.
        \item Пусть $\Delta \vdash_{\xx} M : \sigma$, тогда $\abs{\Delta} \vdash \sigma$.
    \end{enumerate}
\end{theorem}

%% долг с предыдущей лекции
\begin{proof}
\begin{enumerate}
    \item Индукция по выводу $\Delta \vdash_\xx M : \sigma$. Заменяем каждое правило в выводе соответсвующим правилом из ИИВ и получаем доказательство $\Delta \vdash \sigma$.

    \item Индукция по структуре вывода $\Gamma \vdash \sigma$. Пусть $\Gamma = \{\sigma_{1}, \sigma_{2} \ldots\}$,
        $\Delta = \{x_{1}:\sigma_{1}, x_{2}:\sigma_{2}, \ldots \}$.
    \begin{enumerate}[label=(\asbuk*)]
        \item Вывод имеет вид
        \[
            \infer{\Gamma, \varphi \vdash \varphi}{}
        \]
        \begin{enumerate}[label=\roman*.]
            \item Если $\varphi \in \Gamma$, то $\Delta \vdash x_\varphi : \varphi$.
            \item Если $\varphi \notin \Gamma$, то $\Delta, x_\varphi : \varphi \vdash x_\varphi : \varphi$.
        \end{enumerate}

        \item Вывод заканчивается правилом
        \[
            \infer{\Gamma \vdash \psi}{\Gamma \vdash \varphi \rightarrow \psi && \Gamma \vdash \varphi}
        \]
        По индукционному предположению $\Delta \vdash M : \varphi \rightarrow \psi$ и $\Delta \vdash N : \varphi$. Тогда
        \[
            \infer{\Gamma \vdash MN : \psi}{\Gamma \vdash A : \varphi \rightarrow \psi && \Gamma \vdash B : \varphi}
        \]

        \item Вывод заканчивается правилом
        \[
            \infer{\Gamma \vdash \varphi \rightarrow \psi}{\Gamma,\varphi \vdash \psi}
        \]
        \begin{enumerate}[label=\roman*.]
            \item Пусть $\varphi \in \Gamma$. Тогда по индукционному предположению $\Delta \vdash M : \psi$.
            Пусть $x \notin \dom(\Delta)$ (новая переменная).
            Тогда можно изменить построенное доказательство и получить $\Delta, x : \varphi \vdash M : \psi$. Тогда
            \[
                \infer{\Delta \vdash \lambda x^\varphi . M : \varphi \rightarrow \psi}{\Delta, x : \varphi \vdash M : \psi}
            \]

            \item Пусть $\varphi \notin \Gamma$. Тогда по индукционному предположению $\Delta, x^\varphi : \varphi \vdash M : \psi$. Тогда
            \[
                \infer{\Delta \vdash \lambda x^\varphi . M : \varphi \rightarrow \psi}{\Delta, x : \varphi \vdash M : \psi}
                \qedhere
            \]
        \end{enumerate}
    \end{enumerate}
\end{enumerate} %есть в Curry-Howard Isomorphism, стр 75
\end{proof}
